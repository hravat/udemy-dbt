# 1. Use a stable Python base
FROM python:3.10-slim

# 2. Essential system libraries
RUN apt-get update && \
    apt-get install -y curl git unzip bash procps libc6 libstdc++6 && \
    rm -rf /var/lib/apt/lists/*

# 3. Install 'uv' for super-fast dependency management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# 4. Install dbt Fusion CLI (The binary tool)
RUN curl -fsSL https://public.cdn.getdbt.com/fs/install/install.sh | bash -s -- --update
ENV PATH="/root/.local/bin:${PATH}"

# 5. Setup Dagster Environment
WORKDIR /opt/dagster/app
ENV DAGSTER_HOME=/opt/dagster/dagster_home
RUN mkdir -p $DAGSTER_HOME

# 6. Install core dependencies using uv
# --system tells uv to install into the global container environment
# Use uv for high-speed, reliable installations
RUN uv pip install --system \
    dagster \
    dagster-webserver \
    dagster-postgres \
    dagster-dbt \
    dbt-databricks \
    dagster-dg-cli

# 7. Copy your entire app directory
# (Remember: your .dockerignore will keep the .venv out!)
#COPY . .

# 8. Install your projects in 'editable' mode
# This ensures Python can find 'dagster_airbnb' and 'dagster_airbnb_new'
#RUN uv pip install --system -e ./dagster_airbnb && \
#    uv pip install --system -e ./dagster-airbnb-new

# 9. Final Setup
ENV SHELL=/bin/bash
EXPOSE 3000

# Start the webserver (Workspace.yaml will point to your projects)
CMD ["dg", "dev", "-h", "0.0.0.0", "-p", "3000"]